<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Test-driven data pipelining | Sam&#39;s Work Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="When to test, and why: • Write a test for every method.
• Write a test any time you find a bug! Then make sure the test passes after you fix the bug.
• Think of tests as showing how your code should be used, and write them accordingly. The next person who&rsquo;s going to edit your code, or even just use your code, should be able to refer to your tests to see what&rsquo;s happening.">
    <meta name="generator" content="Hugo 0.121.2">
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    

    
      

    

    

    
      <link rel="canonical" href="https://example.org/posts/engineering/test-driven-data-pipelining/">
    

    <meta property="og:title" content="Test-driven data pipelining" />
<meta property="og:description" content="When to test, and why: • Write a test for every method.
• Write a test any time you find a bug! Then make sure the test passes after you fix the bug.
• Think of tests as showing how your code should be used, and write them accordingly. The next person who&rsquo;s going to edit your code, or even just use your code, should be able to refer to your tests to see what&rsquo;s happening." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/engineering/test-driven-data-pipelining/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-02-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-02-08T00:00:00+00:00" />

<meta itemprop="name" content="Test-driven data pipelining">
<meta itemprop="description" content="When to test, and why: • Write a test for every method.
• Write a test any time you find a bug! Then make sure the test passes after you fix the bug.
• Think of tests as showing how your code should be used, and write them accordingly. The next person who&rsquo;s going to edit your code, or even just use your code, should be able to refer to your tests to see what&rsquo;s happening."><meta itemprop="datePublished" content="2016-02-08T00:00:00+00:00" />
<meta itemprop="dateModified" content="2016-02-08T00:00:00+00:00" />
<meta itemprop="wordCount" content="682">
<meta itemprop="keywords" content="pandas,testing,python," /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Test-driven data pipelining"/>
<meta name="twitter:description" content="When to test, and why: • Write a test for every method.
• Write a test any time you find a bug! Then make sure the test passes after you fix the bug.
• Think of tests as showing how your code should be used, and write them accordingly. The next person who&rsquo;s going to edit your code, or even just use your code, should be able to refer to your tests to see what&rsquo;s happening."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Sam&#39;s Work Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Test-driven data pipelining</h1>
      
      <p class="tracked">
        By <strong>Samantha G. Zeitlin</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2016-02-08T00:00:00Z">February 8, 2016</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id="when-to-test-and-why">When to test, and why:</h2>
<p>• Write a test for every method.</p>
<p>• Write a test any time you find a bug! Then make sure the test passes after you fix the bug.</p>
<p>• Think of tests as showing how your code should be used, and write them accordingly. The next person who&rsquo;s going to
edit your code, or even just use your code, should be able to refer to your tests to see what&rsquo;s happening.</p>
<p>• Think of tests as the way you&rsquo;ll make sure things don&rsquo;t break later when you have to refactor.</p>
<p>• It&rsquo;s perfectly okay to write the name of the test first, and then figure out how to write the rest later. In fact, sometimes it helps to write the test so that you know it will fail, and then use that to write better code. That&rsquo;s <em>test-driven development</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_whether_examples_return_likes</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span> 
</span></span></code></pre></div><p>• <strong>Give your test a MEANINGFUL name.</strong></p>
<p>The name should say exactly what the expected behavior is.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_savings_meets_minimum_requirement</span>(self):
</span></span><span style="display:flex;"><span>        savings<span style="color:#f92672">.</span>pct <span style="color:#f92672">=</span> calculate_savings()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>assertGreater(savings<span style="color:#f92672">.</span>pct, <span style="color:#ae81ff">5</span>)
</span></span></code></pre></div><p>• <strong>Tests should be independent of each other.</strong></p>
<p>If you&rsquo;re thinking about writing a test, first check whether a similar test already exists. Don&rsquo;t duplicate existing tests, because that can create confusion when looking at how many tests fail (creating the impression that things are more broken than they actually are).</p>
<h2 id="what-to-test">What to Test</h2>
<p>• <strong>Start with user stories</strong>. What do they expect to see? Test for that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_visits_landing_page</span>(self): 
</span></span><span style="display:flex;"><span>    	    self<span style="color:#f92672">.</span>assertIn(title, landing_page)
</span></span></code></pre></div><p>• Confirm expected data types</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_answer_dict_creation</span>(self):
</span></span><span style="display:flex;"><span>            named <span style="color:#f92672">=</span> answer_dict()
</span></span><span style="display:flex;"><span>    	    self<span style="color:#f92672">.</span>assertTrue(isinstance(named, dict))
</span></span></code></pre></div><p>• Confirm expected attributes on objects</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_profile1_has_no_names</span>(self):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertEqual(len(profile1<span style="color:#f92672">.</span>names), <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_profile2_has_three_names</span>(self):
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertEqual(len(profile2<span style="color:#f92672">.</span>names), <span style="color:#ae81ff">3</span>)
</span></span></code></pre></div><p>• <strong>Features</strong> you haven&rsquo;t finished writing yet (Test-Driven Development)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_user_horoscope_is_accurate</span>(self):
</span></span><span style="display:flex;"><span>            prediction <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertEqual(reality, prediction)
</span></span><span style="display:flex;"><span>        
</span></span></code></pre></div><p>It&rsquo;s okay (and faster) to group assertions together in one test if they all refer to the same object:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> name, lookup <span style="color:#f92672">in</span> get_answers(question):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>assertTrue(isinstance(name, str))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>assertTrue(isinstance(lookup, dict))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>assertTrue(isinstance(lookup[name], pd<span style="color:#f92672">.</span>DataFrame))
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>assertIn(<span style="color:#e6db74">&#39;answer_name&#39;</span>, lookup[name]<span style="color:#f92672">.</span>columns)
</span></span></code></pre></div><p>• <strong>Test pipelines</strong> sequentially and swap in positive controls for all variables except the one you&rsquo;re testing. Then in the final tests, test the whole pipeline and use only test data. You might want to do this for more complicated features. It ends up looking something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_query_returns_objects</span>(self):
</span></span><span style="display:flex;"><span>            actual_obj_list <span style="color:#f92672">=</span> query()
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertEqual(set(expected_obj_list), set(actual_obj_list))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_make_dataframes_from_query_objects</span>(self):
</span></span><span style="display:flex;"><span>            expected_obj_list <span style="color:#f92672">=</span> query()
</span></span><span style="display:flex;"><span>            query_obj_dataframe<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame<span style="color:#f92672">.</span>from_records(expected_obj_list<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertTrue(isinstance(query_obj_dataframe, pd<span style="color:#f92672">.</span>Dataframe))
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_query_returns_objects_and_makes_dataframes</span>(self):
</span></span><span style="display:flex;"><span>            actual_obj_list <span style="color:#f92672">=</span> query()
</span></span><span style="display:flex;"><span>            query_obj_dataframe<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame<span style="color:#f92672">.</span>from_records(actual_obj_list<span style="color:#f92672">.</span>values())
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertTrue(isinstance(query_obj_dataframe, pd<span style="color:#f92672">.</span>Dataframe))
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>assertIn(<span style="color:#e6db74">&#39;total success&#39;</span>, query_obj_dataframe<span style="color:#f92672">.</span>columns)
</span></span></code></pre></div><p>•<strong>Write tests for how to handle expected obstacles and failures</strong></p>
<p>Write tests for things like &ldquo;test_data_cleaning&rdquo; and &ldquo;test_handle_missing_values&rdquo;. Don&rsquo;t expect to rely on inserting a debugger every time something breaks. If the same piece of code breaks more than once, you&rsquo;ve already wasted time by not writing a test.</p>
<p><strong>Don&rsquo;t</strong></p>
<p>• Don&rsquo;t test too many things in one test, unless you have sufficient coverage of all the supporting parts. The whole point of unittests is to help isolate the causes of problems, particularly when you change things later, i.e. to help speed up refactoring and adding new features.</p>
<p>• Don&rsquo;t write useless tests. If the test fails and tells you nothing about why it failed, you did it wrong.</p>
<p>• It&rsquo;s generally considered poor form to put assertions in main code. Assertions are best used in testing. If you want to check for something in the code, use an if statement. However, if a condition is expected to only occur if something has gone horribly wrong, you should raise a custom exception. This can be tremendously helpful for debugging, for example, if database queries are failing.</p>
<p>Don&rsquo;t do this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assertNoErrors</span>(self, resp, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>assertEqual(len(resp[<span style="color:#e6db74">&#39;messages&#39;</span>][<span style="color:#e6db74">&#39;error&#39;</span>]), <span style="color:#ae81ff">0</span>, msg)
</span></span></code></pre></div><p>Better:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">assertNoErrors</span>(self, resp, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>):
</span></span><span style="display:flex;"><span>    	<span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>	    self<span style="color:#f92672">.</span>assertEqual(len(resp[<span style="color:#e6db74">&#39;messages&#39;</span>][<span style="color:#e6db74">&#39;error&#39;</span>]), <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">AssertionError</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> resp[<span style="color:#e6db74">&#39;messages&#39;</span>][<span style="color:#e6db74">&#39;error&#39;</span>] 
</span></span><span style="display:flex;"><span>            
</span></span></code></pre></div><p><strong>Running tests</strong></p>
<ol>
<li>Run tests locally. Whether you&rsquo;re just running unit tests, or django tests, or using some other library (nose, pytest, etc.), you can run single tests, whole test folders or the entire test suite.</li>
<li>Set up and run automated tests through something like Jenkins. Keep in mind that Jenkins may not be using the same database that you&rsquo;re using locally.</li>
<li>Test manually both locally and remotely.</li>
<li>Get someone else to test manually both specifically (black-box testing) and randomly (smoke-testing).</li>
</ol>
<ul class="pa0">
  
   <li class="list di">
     <a href="/tags/pandas/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">pandas</a>
   </li>
  
   <li class="list di">
     <a href="/tags/testing/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">testing</a>
   </li>
  
   <li class="list di">
     <a href="/tags/python/" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/posts/engineering/data-pipelining-with-pandas-automating-lookup-and-update/">Data pipelining with pandas</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/engineering/things-i-learned-about-zip-files-last-week/">Things I learned about zip files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/posts/engineering/recursion-excursion/">Recursion excursion</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://example.org/" >
    &copy;  Sam's Work Blog 2024 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
